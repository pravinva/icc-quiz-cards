name: Auto-merge PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review:
    types: [submitted]
  workflow_dispatch:

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Check if PR should be auto-merged
        id: check
        env:
          BRANCH_NAME: ${{ github.head_ref }}
          REVIEW_STATE: ${{ github.event.review.state }}
        run: |
          # Auto-merge if:
          # 1. PR is from a claude/ branch, OR
          # 2. PR has been approved

          echo "Branch: $BRANCH_NAME"
          echo "Review state: $REVIEW_STATE"

          if [[ "$BRANCH_NAME" == claude/* ]]; then
            echo "auto_merge=true" >> $GITHUB_OUTPUT
            echo "reason=Claude branch detected" >> $GITHUB_OUTPUT
          elif [[ "$REVIEW_STATE" == "approved" ]]; then
            echo "auto_merge=true" >> $GITHUB_OUTPUT
            echo "reason=PR approved" >> $GITHUB_OUTPUT
          else
            echo "auto_merge=false" >> $GITHUB_OUTPUT
          fi

      - name: Enable auto-merge
        if: steps.check.outputs.auto_merge == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "Enabling auto-merge for PR #$PR_NUMBER (${{ steps.check.outputs.reason }})"
          gh pr merge $PR_NUMBER --auto --squash --delete-branch --repo ${{ github.repository }}
